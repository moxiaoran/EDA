---
title: "Monte Carlo"
author: "Yifei Liu"
date: "2/19/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

```{r}
library(forcats)
library(tidyverse)
library(scales)
library(ggfortify)
detach("package:dplyr", unload=TRUE)
library(dplyr)
theme_set(theme_minimal())

```



Estimating $\pi$

```{r}
estimate_pi <- function(n) {
  count = 0
  for (i in 1:n) {
    x = runif(1)
    y = runif(1)
    if ((x - 0.5) ^ 2 + (y - 0.5) ^ 2 <= 0.5^2)
      count = count + 1
  }
  PI = 4 * count / n
  print(PI)
}

estimate_pi(10000)


```

```{r}
n <- 5000


points <- tibble("x" = runif(n), "y" = runif(n))


points <- points %>% 
  mutate(inside = if_else(x^2 + y^2 < 1, 1, 0),
         N = row_number(),
         estimate = 4*cumsum(inside)/N)

ggplot(points) + 
  geom_line(aes(y = estimate, x = N), colour = "#82518c") + 
  geom_hline(yintercept = pi)

```



Discretized Stock Prcoess


```{r}
geo_paths <- function(s, r, q, sd, t, n) {
  paths = NULL
  paths[1] = s
  dt = t/n
  drift = (r - sd^2 /2) * dt
  risk = sd * sqrt(dt)
  for (i in 1:n) {
    paths[i + 1] = paths[i] * exp(drift + risk * rnorm(1))
  }
  paths <- as.ts(paths)
  return(paths)
}

geo_price <- geo_paths(40, 0.05, 0.03, 0.35, 3, 3*252)

autoplot(geo_price) + 
  scale_y_continuous(labels = dollar_format())
  


```



BS European Call

```{r}
BSCallMC <- function(s, k, r, q, t, sd, nr) {
  drift = (r - q - sd^2/2) * t
  risk = sd * sqrt(t)
  st <- NULL
  intrinsic <- NULL
  prices <- NULL
  for(i in 1:nr) {
    st[i] = s * exp(drift + risk * rnorm(1))
    intrinsic[i] = max(0, st[i] - k)
    prices[i] <- exp(-r*t) * intrinsic[i]
  }
  
  return(mean(prices))
}

BSCallMC(20, 20, 0.03, 0, 5/12, 0.25, 10000)




```





Extra 
=====
1. RANDU is an infamus linear congruential pseudorandom number generator which has been used since the 1960s in what way could it be judged faulty

Answer: See the 2D and 3D graphic, the algrothim in close inspection, fail to file the uniformaly

2. What is mean by the Quasi Monte Carlo?

Anser: it been generated deterministely way, have systemically bias, not real random number. 

3. Quasi Random Sequence using a base 2 manipualtion

Answer: 

1 = 1.0 = 0.1 = 1/2
2 - 11.0 = 0.01 = 1/4
3 = 11.0 = 0.11 = 3/4
4 = 100,0 = 0.001 = 1/8
5 = 101.0 = 0.101 = 5/8

4 $p_[X=0] = e^(-)$

m equalt the number of jumps in interval of times

$z_i $ stand normal variable $N(0,1)$ percentage of change

$v_j$ expected size of jump p

$\sigma_i$ volatility in the jump size


$$Y = e^{m*(\alpha_j - 0.5\sigma_j^2) + \sigma_j * \sum_{1}^{m}{z}}$$

5 A:

How could the merton jump diffusion model explain observed equility volatltiy smiles?


1. Collect data cp for range 

why we observe volatility smiles
Answer: Returns not lognormal, heavy right tails

2.  regressional equation

$\sigma_{iv} = q_o + q_1k + q_2k + q_3T + q_sKT$

$dx = udt + \sigma{dw_t}$ = drift + diffusion coefficient 


Constant Elasticity of Variance - CEV

$ds/s = (r-q)dt + \sigma{dw}$ 

If we want stock to have volatility of $\sigma_0$ at Current S:
$\sigma = \sigma_0 S^{(2-\beta)/2}$ 

$\beta < 2$ Volatility decrease with Stock Price

Volatility in this case is either fixed or random. 

8. 

b. Show that it exhibits constant elasticity of variance?

$\sigma^2 = \sigma_0^2{S\beta}$

Discrete method of CEV

$ds = (r-q)sdt + \sigma{s^{\beta/2}}dw$
$d*lns = 1/s *ds + 1/2 * (-1/s^2)(ds)^2$
$s_{\delta_t} = s_0 * exp\{(r-q) - 1/2 *\sigma^2*s^{\beta-2} + \sigma*s^{\beta-2}\}$


CEVpath
```{r}
CEVPath <- function(s,r,q,vol0, beta, t, n) {
  set.seed(2019)
  path <- NULL
  path[1] <- s
  sigma = vol0*s^((2-beta)/2)
  dt = t/n
  sqrtdt = sqrt(dt)
  var = sigma^2
  for (i in 1:n) {
    drift = (r - q - 0.5 * var * path[i]^(beta-2)) * dt
    risk = sigma * (path[i]^((beta-2)/2)*sqrtdt)
    path[i+1] = path[i] * exp(drift + risk * rnorm(1))
  }
  path_ts = as.ts(path)
  return(path_ts)
 
}


price_ts <- CEVPath(100, 0.026, 0.015, 0.18, 1, 1, 252)

 autoplot(price_ts) +
    theme_bw() +
    scale_y_continuous(labels = dollar_format()) +
    labs(x= "", y = "", title = "CEV")

```

Volpath

```{r}


```








